extends ../../layout

block head
    link(rel='stylesheet', href='../../css/CardIndex.css')
    link(rel='stylesheet', href='../../css/BeatPicker.min.css')
    script(src='../../js/BeatPicker.min.js')
block content

    mixin list(img, cardName, predict, condition, range, maintype, cardState, applyState, cardTypeId, fsid, srcimg,applysid)
        tr
            td
                input(type='checkbox', name='se')
            td
                .pic
                    .img
                        - var imgS = imgurl + srcimg
                        img(src=imgS)
            td #{cardName}
            td #{predict}
            td #{condition}
            td #{range}
            td #{maintype}
            if cardState === '0'
                if applyState === '0'
                    td.zt
                        span.dsj 草稿
                    td.dr-cz
                        - var url = 'draft_edit?card_type_id=' + cardTypeId + '&fsid=' + fsid
                        - var url2 = 'draft_detail?apply=0&card_type_id=' + cardTypeId + '&fsid=' + fsid
                        a.detail(href=url) 卡片管理
                        a(href=url2 data-apply=cardTypeId) 提交审核
                    td.dr-bz
                        span.btg 审核不通过
                        span.reason 查看原因
                else if applyState === '2'
                    td.zt
                        span.dsj 草稿
                    td.dr-cz
                        - var url = 'draft_edit?card_type_id=' + cardTypeId + '&fsid=' + fsid
                        - var url2 = 'draft_detail?apply=0&card_type_id=' + cardTypeId + '&fsid=' + fsid
                        a.detail(href=url) 卡片管理
                        a(href=url2 data-apply=cardTypeId) 提交审核
                    td.dr-bz
                        span 已撤销审核
                else
                    td.zt
                        span.dsj 草稿
                    td.dr-cz
                        - var url = 'draft_edit?card_type_id=' + cardTypeId + '&fsid=' + fsid
                        - var url2 = 'draft_detail?apply=0&card_type_id=' + cardTypeId + '&fsid=' + fsid
                        a.detail(href=url) 卡片管理
                        a(href=url2 data-apply=cardTypeId) 提交审核
                    td.dr-bz
            else if cardState === '1'
                td.zt
                    span.ysj 审核中
                td.dr-cz
                    - var url2 = 'draft_detail?card_type_id=' + cardTypeId + '&fsid=' + fsid
                    a.detail(href=url2) 查看详情
                    span.delll(data-delll=cardTypeId sid=applysid) 撤销审核
                td.dr-bz

    include ../../include/card_header
    .container
        .content
            include ../../include/cardSide
            .mainInclude
                .m-content.clearfix
                    .page-title
                        a.home(href='/card')
                        span / 虚拟卡中心 /
                        span.last 草稿箱
                    input(id="refreshed" value="no" style='display: none')
                    .main-container
                        .pagecont
                            .cardTop.draft
                                .searchBox
                                    .sea-line
                                        span 卡片名称：
                                        input.xnk(type='text', placeholder='请输入名称' value=typename)#typename
                                    .sea-line
                                        span 卡片类型：
                                        select.lx#maintype
                                            option 全部
                                            // for data , i in objmaintype
                                            //     if data !== ''
                                            //         if i === maintype
                                            //             option(value=i selected='selected') #{data}
                                            //         else
                                            //             option(value=i) #{data}
                                    .sea-line
                                        span 状态：
                                        select.fws#cardstate
                                            option(value='') 全部
                                            if cardstate === '0'
                                                option(value='0' selected='selected') 草稿
                                                option(value='1') 审核中
                                            else if cardstate === '1'
                                                option(value='0') 草稿
                                                option(value='1' selected='selected') 审核中
                                            else
                                                option(value='0') 草稿
                                                option(value='1') 审核中
                                    .sea-line
                                        a.sear 搜索
                                        a.reset 重置
                                ul.tab-hitle
                                    li.addCard 新建卡片
                                    li.del 删除
                                .tab-panel
                                    .tab-item
                                        .tab-center
                                            table
                                                thead
                                                    tr
                                                        th(width='70px')
                                                            input#all(type='checkbox')
                                                        th(width='140px') 卡片logo
                                                        th(width='130px') 卡片名称
                                                        th(width='130px') 预估额度
                                                        th(width='140px') 申请条件
                                                        th(width='130px') 应用范围
                                                        th(width='130px') 卡片类型
                                                        th(width='130px') 状态
                                                        th(width='130px') 操作
                                                        th(width='130px') 备注
                                                tbody.xj
                                                    for data , i in cardList.pageList
                                                        - var img = ''
                                                        - var cardName = data.typename
                                                        - var predict = data.predict
                                                        - var condition = data.condition
                                                        - var range = data.range
                                                        - var maintype = data.maintype
                                                        - var cardState = data.cardstate
                                                        - var applyState = data.approveresult
                                                        - var cardTypeId = data.cardTypeId
                                                        - var fsid = data.sid
                                                        - var ssid = data.card_type_contract.sid
                                                        - var srcimg = data.clog
                                                        - var applysid = data.applysid
                                                        +list(img, cardName, predict, condition, range, maintype, cardState, applyState, cardTypeId, fsid, srcimg, applysid)

                                            .zxf_pagediv
    script.
        $(function () {
            var e = document.getElementById("refreshed");
            if (e.value === "no") {
                e.value = "yes";
            } else if (e.value === "yes") {
                e.value = "no";
                window.location.reload();
            }

            //全选效果
            $('#all').on('click', function () {
                $(".xj input[type='checkbox']").prop("checked", $("#all").prop("checked"));
            });
            $(".xj input[type='checkbox']").each(function () {
                $(this).on('click', function () {
                    var allCheckNum = $(".xj input[type='checkbox']").length;
                    var checkedNum = $(".xj input[type='checkbox']:checked").length;
                    if (allCheckNum == checkedNum) {
                        $("#all").prop("checked", 'checked');//全被选中
                    } else {
                        $("#all").prop("checked", '');//部分选中
                    }
                })
            });

            // $('.sear').on('click', function () {
            //     var xnk = $('.xnk').val();
            //     var fws = $('.fws').val();
            //     var lx = $('.lx').val();
            //     console.log(xnk, fws, lx);
            // });

            // $('.reset').on('click', function () {
            //     $('.searchBox input').val("");
            //     $('.searchBox select').val("全部")
            // });

            //选中项操作
            $('.btn').on('click', function () {

                if ($("#all").prop("checked") == true) {
                    console.log(3)
                } else {
                    $(".xj input[type='checkbox']").each(function () {
                        if ($(this).prop('checked') == true) {
                            console.log(1);
                        } else {
                            console.log(2);
                        }
                    })
                }

            })
            // 新建虚拟卡弹窗
            $('.addCard').on('click', function () {

                zeroModal.show({
                    title: "新建虚拟卡",
                    content: "<div class=\'xj-popup\'><span class=\'zer-type\'>虚拟卡名称：</span><input type=\'text\' id=\'cardName\'><div class=\'title\'>请输入卡片名称</div></div>" +
                    "<div class=\'xj-popup\'><span class=\'zer-type\'>虚拟卡类型：</span><select class=\'zer-select\' id=\'typeName\'><option value=\'\'>请选择</option><option value=\'0\'>通用信用支付卡</option><option value=\'1\'>信用支付专项卡</option><option value=\'2\'>分期支付专项卡</option></select><div class=\'title\'>请选择卡片类型</div>" +
                    "</div><div class=\'xj-popup\'><span class=\'zer-type\' id=\'tagName\'>卡片标签：</span></div>",
                    ok: true,
                    height: '350px',
                    cancel: true,
                    okFn: function () {
                        var Typename = $('#cardName').val();
                        var Maintype = $('#typeName').val();
                        if(Typename === ''){
                            zeroModal.error('名字不能为空')
                            return false
                        }else if (Maintype === '') {
                            zeroModal.error('类型不能为空')
                            return false
                        }
                        var tag_s = "";//定义一个数组
                        $('input:checked').each(function () {//遍历每一个名字为interest的复选框，其中选中的执行函数
                            if (tag_s == "") {
                                tag_s = $(this).val();
                            } else {
                                tag_s += "," + $(this).val();
                            }
                        });


                       $.post('/api/Api_CARD_MARKET_TYPE_A1_Request', {
                           Typename : Typename,
                           Maintype : 2,
                           Cardstate : '0',
                           Aid : '#{loginaid}',
                           Profiles : '0',
                           Range : '0',
                           Condition : '0' ,
                           Predict : '0',
                           Card_tags : tag_s
                       }, function (res) {
                           console.log(res.status.resultcode)
                           if (res.status.resultcode === '0') {
                               window.location.reload()
                           } else {
                               zeroModal.error('网络异常,请稍候再试')
                           }
                       })
                    }
                })
                var arrtag = !{JSON.stringify(tagList.pageList)};
                var ahtml = '';
                for (var i = 0; i < arrtag.length; i++) {
                    ahtml += '<label class=\'bq\'><input type=\'checkbox\' value=' + arrtag[i].sid + '>' + arrtag[i].tagname + '</label>'
                    if (i+1 === arrtag.length){
                        document.getElementById('tagName').insertAdjacentHTML('afterEnd', ahtml);
                    }
                }


            })
        })
        //功能开发中 .del
        $('.sear').on('click', function () {
            window.location.href = '/card/cardc/draft?typename=' + $('#typename').val() + '&cardstate=' + $('#cardstate').val() + '&maintype=' + $('#maintype').val()
            // zeroModal.alert('功能开发中')
        })
        $('.reset').on('click', function () {
            window.location.href = '/card/cardc/draft'
            // zeroModal.alert('功能开发中')
        })
        $('.editCard').on('click', function () {
            zeroModal.alert('功能开发中')
        })
        $('.reason').on('click', function () {
            zeroModal.alert('功能开发中')
        })
        $('.del').on('click', function () {
            zeroModal.alert('功能开发中')
        })
        //撤销审核
        $('.delll').on('click', function () {
            $.post('/api/Api_CARDMACKETAPPLY_A5_cancelCardReq_Request', {
                Card_type_id: $(this).attr('data-delll'),
                Sid: $(this).attr('sid')
            }, function (res) {
                console.log(res.status.resultcode)
                if (res.status.resultcode === '0') {
                    window.location.reload()
                } else {
                    zeroModal.error('网络异常,请稍候再试')
                }
            })
        })
